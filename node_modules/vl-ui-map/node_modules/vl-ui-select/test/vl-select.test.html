<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>

  <script type="module" src="../vl-select.src.js"></script>
</head>
<body>
<test-fixture id="vl-select-fixture">
  <template>
    <select id="select-1" is="vl-select"/>
  </template>
</test-fixture>


<test-fixture id="vl-select-auto-dress-fixture">
  <template>
    <select id="select-2" data-vl-select is="vl-select"/>
  </template>
</test-fixture>

<script>
  suite('vl-select', () => {
    const sandbox = sinon.createSandbox();

    setup((done) => {
      customElements.whenDefined('vl-select').then(() => {
        sandbox.spy(window.vl.select, 'dress');
        sandbox.spy(window.vl.select, 'undress');
        sandbox.spy(window.vl.select, 'enable');
        sandbox.spy(window.vl.select, 'disable');
        sandbox.spy(window.vl.select, 'removeActive');
        sandbox.spy(window.vl.select, 'setValueByChoice');
        sandbox.spy(window.vl.select, 'showDropdown');
        sandbox.spy(window.vl.select, 'hideDropdown');
        done();
      });
    });

    teardown(() => {
      sandbox.restore();
    });

    test('heeft de vl-select class', () => {
      const element = fixture('vl-select-fixture');
      assert.isTrue(element.classList.contains('vl-select'));
    });

    test('krijgt de juiste class wanneer het element een correct attribuut bevat', () => {
      const element = fixture('vl-select-fixture');
      ['block', 'error', 'success', 'disabled'].forEach((attribuut) => {
        assert.isFalse(element.classList.contains('vl-select--' + attribuut));
        element.setAttribute(attribuut, '');
        assert.isTrue(element.classList.contains('vl-select--' + attribuut));
        element.removeAttribute(attribuut);
        assert.isFalse(element.classList.contains('vl-select--' + attribuut));
      });
    });

    test('krijgt geen class wanneer het veld een onbeschikbaar attribuut bevat', () => {
      const element = fixture('vl-select-fixture');
      const attribuut = 'onbeschikbaarattribuut';
      element.setAttribute(attribuut, '');
      assert.isFalse(element.classList.contains('vl-select--' + attribuut));
    });

    test('de dress methode callt vl.select.dress', (done) => {
      const element = fixture('vl-select-fixture');
      element.dress();
      setTimeout(() => {
        assert(window.vl.select.dress.calledWith(element));
        done();
      });
    });

    test('de dress methode callt vl.select.dress niet als dressed attribuut al gezet is', (done) => {
      const element = fixture('vl-select-fixture');
      element.setAttribute('data-vl-select-dressed', 'true');
      element.dress();
      setTimeout(() => {
        assert(window.vl.select.dress.notCalled);
        done();
      });
    });

    test('de dress methode met params callt vl.select.dress met params', (done) => {
      const element = fixture('vl-select-fixture');
      let params = {callbackFn: () => {}};
      element.dress(params);
      setTimeout(() => {
        assert(window.vl.select.dress.calledWith(element, params));
        done();
      });
    });

    test('de undress methode callt vl.select.undress niet als dressed atribuut niet is gezet', () => {
      const element = fixture('vl-select-fixture');
      element.undress();
      assert(window.vl.select.undress.notCalled);
    });

    test('de undress methode callt vl.select.undress met de choices instantie enkel als dressed atribuut is gezet', (done) => {
      const element = fixture('vl-select-auto-dress-fixture');
      setTimeout(() => {
        element.undress();
        const selectInstance = vl.select.selectInstances.find((instance) => {
          return instance.element === element;
        });
        assert(window.vl.select.undress.calledWith(selectInstance));
        done();
      });
    });

    test('de enable methode callt vl.select.enable', () => {
      const element = fixture('vl-select-fixture');
      element.enable();
      assert(window.vl.select.enable.calledWith(element));
    });

    test('de disable methode callt vl.select.enable', () => {
      const element = fixture('vl-select-fixture');
      element.disable();
      assert(window.vl.select.disable.calledWith(element));
    });

    test('de removeActive methode callt vl.select.removeActive', () => {
      const element = fixture('vl-select-fixture');
      element.removeActive();
      assert(window.vl.select.removeActive.calledWith(element));
    });

    test('de setValueByChoice methode callt vl.select.setValueByChoice', () => {
      const element = fixture('vl-select-fixture');
      element.setValueByChoice('test123');
      assert(window.vl.select.setValueByChoice.calledWith(element, 'test123'));
    });

    test('de showDropdown methode callt vl.select.showDropdown', () => {
      const element = fixture('vl-select-fixture');
      element.showDropdown();
      assert(window.vl.select.showDropdown.calledWith(element));
    });

    test('de hideDropdown methode callt vl.select.hideDropdown', () => {
      const element = fixture('vl-select-fixture');
      element.hideDropdown();
      assert(window.vl.select.hideDropdown.calledWith(element));
    });

    test('de mogelijkheden kunnen achteraf nog bepaald worden', (done) => {
      const element = fixture('vl-select-auto-dress-fixture');
      setTimeout(() => {
        const selectInstance = vl.select.selectInstances.find((instance) => {
          return instance.element === element;
        });
        sandbox.spy(selectInstance, 'setChoices');
        const data = [{
          value: 'test value',
          label: 'test label'
        }];
        element.choices = data;
        assert(selectInstance.setChoices.calledWith(data, 'value', 'label', true));
        done();
      });
    });

    test('het zetten van de sortFilter zorgt er voor de choices config aangepast worden met een sortFilter', (done) => {
      const element = fixture('vl-select-auto-dress-fixture');
      setTimeout(() => {
        const sortFn = (item1, item2) => item1.id > item2.id;
        element.sortFilter = sortFn;
        const selectInstance = vl.select.selectInstances.find((instance) => {
          return instance.element === element;
        });
        assert.equal(selectInstance.config.sortFilter, sortFn);
        done();
      });
    });

    test('bij het toevoegen van een select element aan de DOM zal de dress functie aangeroepen worden zodat de select functionaliteit geactiveerd wordt', (done) => {
      const newSelect = document.createElement('select', {is: 'vl-select'});
      newSelect.setAttribute('data-vl-select', '');
      document.body.appendChild(newSelect);
      setTimeout(() => {
        assert(window.vl.select.dress.called);
        done();
      });
    });

    test('de dress functie wordt maar 1 keer aangeroepen per select element', (done) => {
      const element = fixture('vl-select-auto-dress-fixture');
      setTimeout(() => {
        assert.lengthOf(vl.select.selectInstances.filter((instance) => {
          return instance.element === element;
        }), 1);
        done();
      });
    });
  });
</script>
</body>
</html>